name: Sync BC GB Code

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Get current version
        id: current
        run: |
          if [ -f .bc-version ]; then
            CURRENT_VERSION=$(cat .bc-version)
            echo "Current version: $CURRENT_VERSION"
            echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          else
            echo "No version file found, will sync latest"
            echo "version=gb-0" >> $GITHUB_OUTPUT
          fi
          
          # Get current commit SHA if we have a version file
          if [ -f .bc-version ] && [ "$CURRENT_VERSION" != "gb-0" ]; then
            CURRENT_SHA=$(git ls-remote https://github.com/StefanMaron/MSDyn365BC.Code.History.git "refs/heads/$CURRENT_VERSION" | awk '{print $1}')
            echo "Current SHA: $CURRENT_SHA"
            echo "sha=$CURRENT_SHA" >> $GITHUB_OUTPUT
          else
            echo "sha=" >> $GITHUB_OUTPUT
          fi
      
      - name: Fetch latest GB version from source repo
        id: latest
        run: |
          # Use git ls-remote to efficiently get only gb- branches
          echo "Fetching GB branches from source repository..."
          
          # Get all gb- branches with their SHAs using git ls-remote
          GB_BRANCHES_WITH_SHA=$(git ls-remote --heads https://github.com/StefanMaron/MSDyn365BC.Code.History.git 'refs/heads/gb-*')
          
          # Debug: Show all gb-* branches found
          echo "All GB branches found:"
          if [ -z "$GB_BRANCHES_WITH_SHA" ]; then
            echo "No gb- branches found"
            exit 1
          else
            echo "$GB_BRANCHES_WITH_SHA" | sed 's|refs/heads/||' | sort -t- -k2 -n
          fi
          
          # Extract version numbers and find highest
          LATEST_BRANCH=$(echo "$GB_BRANCHES_WITH_SHA" | awk '{print $2}' | sed 's|refs/heads/||' | grep '^gb-[0-9]\+$' | sed 's/gb-//' | sort -n | tail -1 | xargs -I {} echo "gb-{}")
          
          # Verify we got a valid version
          if [ -z "$LATEST_BRANCH" ]; then
            echo "Error: Could not find any gb-* branches with numeric versions"
            exit 1
          fi
          
          # Get the SHA for the latest branch
          LATEST_SHA=$(echo "$GB_BRANCHES_WITH_SHA" | grep "refs/heads/$LATEST_BRANCH" | awk '{print $1}')
          
          echo "Latest version: $LATEST_BRANCH"
          echo "Latest SHA: $LATEST_SHA"
          echo "branch=$LATEST_BRANCH" >> $GITHUB_OUTPUT
          echo "sha=$LATEST_SHA" >> $GITHUB_OUTPUT
      
      - name: Check if update needed
        id: check
        run: |
          CURRENT_VERSION="${{ steps.current.outputs.version }}"
          CURRENT_SHA="${{ steps.current.outputs.sha }}"
          LATEST_VERSION="${{ steps.latest.outputs.branch }}"
          LATEST_SHA="${{ steps.latest.outputs.sha }}"
          
          echo "Current: $CURRENT_VERSION (SHA: $CURRENT_SHA)"
          echo "Latest:  $LATEST_VERSION (SHA: $LATEST_SHA)"
          
          # Check if version changed OR if SHA changed (content update)
          if [ "$CURRENT_VERSION" = "$LATEST_VERSION" ] && [ "$CURRENT_SHA" = "$LATEST_SHA" ] && [ -n "$CURRENT_SHA" ]; then
            echo "✓ Already up to date with $LATEST_VERSION"
            echo "update_needed=false" >> $GITHUB_OUTPUT
          else
            if [ "$CURRENT_VERSION" != "$LATEST_VERSION" ]; then
              echo "→ Version changed: $CURRENT_VERSION -> $LATEST_VERSION"
            else
              echo "→ Content updated in $LATEST_VERSION"
            fi
            echo "update_needed=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Add source repository as remote
        if: steps.check.outputs.update_needed == 'true'
        run: |
          git remote add source https://github.com/StefanMaron/MSDyn365BC.Code.History.git || true
          git remote set-url source https://github.com/StefanMaron/MSDyn365BC.Code.History.git
      
      - name: Fetch and sync latest version
        if: steps.check.outputs.update_needed == 'true'
        run: |
          BRANCH="${{ steps.latest.outputs.branch }}"
          echo "Fetching $BRANCH from source repository..."
          
          # Fetch only the specific branch with shallow history
          git fetch source $BRANCH --depth=1
          
          # Remove all files except .git, .github, .bc-version, and README.md
          find . -maxdepth 1 ! -name '.git' ! -name '.github' ! -name '.bc-version' ! -name 'README.md' ! -name '.' -exec rm -rf {} +
          
          # Checkout files from the source branch
          git checkout source/$BRANCH -- . || true
          
          # Restore our workflow files and metadata
          git checkout HEAD -- .github/ .bc-version README.md 2>/dev/null || true
      
      - name: Update version file
        if: steps.check.outputs.update_needed == 'true'
        run: |
          echo "${{ steps.latest.outputs.branch }}" > .bc-version
          git add .bc-version
      
      - name: Commit and push changes
        if: steps.check.outputs.update_needed == 'true'
        run: |
          git add -A
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            BRANCH="${{ steps.latest.outputs.branch }}"
            git commit -m "Sync to Business Central $BRANCH" \
                       -m "Automated sync from StefanMaron/MSDyn365BC.Code.History" \
                       -m "Source branch: $BRANCH" \
                       -m "Sync date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            
            git push origin main
            echo "Successfully synced to $BRANCH"
          fi
      
      - name: Create release tag
        if: steps.check.outputs.update_needed == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="${{ steps.latest.outputs.branch }}"
          TAG_NAME="sync-$BRANCH-$(date +%Y%m%d)"
          
          git tag -a "$TAG_NAME" -m "Business Central $BRANCH code sync"
          git push origin "$TAG_NAME" || echo "Tag already exists or push failed"
      
      - name: Summary
        run: |
          if [ "${{ steps.check.outputs.update_needed }}" = "true" ]; then
            echo "✅ Successfully synced to ${{ steps.latest.outputs.branch }}"
          else
            echo "ℹ️ Already up to date with ${{ steps.current.outputs.version }}"
          fi
